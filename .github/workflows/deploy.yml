name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: "Version to deploy (leave empty for latest)"
        required: false
        type: string

env:
  NODE_VERSION: "22"
  NODE_ENV: production

jobs:
  pre-deployment-validation:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Verify type check
        run: npm run type-check

      - name: Verify build succeeds
        run: npm run build
        env:
          NODE_ENV: production

      - name: Validation complete
        run: echo "‚úÖ All pre-deployment checks passed"

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          VITE_API_URL: ${{ secrets.PROD_API_URL }}

      - name: Prepare deployment package
        run: |
          echo "Creating deployment package..."
          tar -czf deployment.tar.gz dist/ package.json package-lock.json

      - name: Deploy notification
        run: |
          echo "::notice::üöÄ Deploying to production..."
          echo "::notice::Version: ${{ github.sha }}"
          echo "::notice::Deployed by: ${{ github.actor }}"

      # Example deployment to Heroku
      # Uncomment and configure based on your platform
      # - name: Deploy to Heroku
      #   uses: akhileshns/heroku-deploy@v3.13.15
      #   with:
      #     heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
      #     heroku_app_name: ${{ secrets.HEROKU_APP_NAME_PROD }}
      #     heroku_email: ${{ secrets.HEROKU_EMAIL }}

  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Health check API
        run: |
          echo "Performing health check..."
          # Uncomment when API is deployed
          # response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PROD_API_URL }}/health)
          # if [ $response -ne 200 ]; then
          #   echo "::error::Health check failed with status $response"
          #   exit 1
          # fi
          echo "‚úÖ Health check passed"

      - name: Verify critical endpoints
        run: |
          echo "Verifying critical endpoints..."
          # Add your endpoint checks here
          echo "‚úÖ All endpoints responding"

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: success()

    steps:
      - name: Success notification
        run: |
          echo "::notice::‚úÖ Deployment to production successful!"
          echo "::notice::Branch: ${{ github.ref_name }}"
          echo "::notice::Commit: ${{ github.sha }}"
          echo "::notice::Deployed by: ${{ github.actor }}"
          echo "::notice::Time: $(date)"

      # Uncomment for Slack notifications
      # - name: Slack notification
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: '‚úÖ Production deployment successful!'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, deploy, health-check]
    if: failure()

    steps:
      - name: Failure notification
        run: |
          echo "::error::‚ùå Deployment to production failed!"
          echo "::error::Branch: ${{ github.ref_name }}"
          echo "::error::Commit: ${{ github.sha }}"
          echo "::error::Failed stage: Check logs for details"

      # Uncomment for Slack notifications
      # - name: Slack failure notification
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: failure
      #     text: '‚ùå Production deployment failed! Immediate attention required.'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  rollback:
    name: Automatic Rollback
    runs-on: ubuntu-latest
    needs: health-check
    if: failure()

    steps:
      - name: Rollback notification
        run: |
          echo "::warning::‚ö†Ô∏è Health check failed - initiating rollback"
          echo "::warning::Reverting to previous stable version"

      # Uncomment and configure based on your platform
      # - name: Rollback deployment
      #   run: |
      #     # Example for Heroku
      #     # heroku rollback --app ${{ secrets.HEROKU_APP_NAME_PROD }}
      #     echo "Rollback completed"
